<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Downloader</title>
    <style>
        /* Keep all your existing CSS styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        /* ... keep all your existing CSS ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YouTube Video Downloader</h1>
            <p>Download your favorite YouTube videos quickly and easily</p>
        </div>

        <p class="disclaimer">
            <strong>Disclaimer:</strong> This tool is for educational purposes. Please ensure you have permission to download videos and respect copyright laws.
        </p>

        <div class="download-form">
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            
            <div class="input-group">
                <input 
                    type="text" 
                    class="url-input" 
                    id="videoUrl" 
                    placeholder="Paste YouTube video URL here (e.g., https://www.youtube.com/watch?v=...)"
                    autocomplete="off"
                    value="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                >
                <button class="fetch-btn" id="fetchBtn">
                    <span id="fetchText">Fetch Video</span>
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Fetching video information...</p>
            </div>

            <div class="video-info" id="videoInfo">
                <div class="video-preview">
                    <img class="thumbnail" id="videoThumbnail" alt="Video thumbnail">
                    <div class="video-details">
                        <h3 class="video-title" id="videoTitle"></h3>
                        <div class="video-meta">
                            <span id="videoDuration"></span>
                            <span id="videoAuthor"></span>
                            <span id="videoViews"></span>
                        </div>
                    </div>
                </div>
                
                <div class="quality-options" id="qualityOptions">
                    <!-- Quality options will be populated here -->
                </div>
                
                <button class="download-btn" id="downloadBtn">
                    <span id="downloadText">Download Video</span>
                </button>
            </div>

            <div class="instructions">
                <h3>How to Use:</h3>
                <ol>
                    <li>Copy the YouTube video URL from your browser</li>
                    <li>Paste it in the input field above</li>
                    <li>Click "Fetch Video" to get available formats</li>
                    <li>Choose your preferred quality and format</li>
                    <li>Click "Download Video" to start downloading</li>
                </ol>
            </div>

            <div class="api-section">
                <h3>Backend Status</h3>
                <p><strong>Status:</strong> <span id="backendStatus">Checking...</span></p>
                <button onclick="testBackend()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Test Backend Connection</button>
            </div>
        </div>

        <div class="footer">
            <p>YouTube Downloader &copy; 2024 | Frontend: GitHub Pages | Backend: Netlify</p>
        </div>
    </div>

    <script>
        class YouTubeDownloader {
            constructor() {
                this.videoUrl = document.getElementById('videoUrl');
                this.fetchBtn = document.getElementById('fetchBtn');
                this.fetchText = document.getElementById('fetchText');
                this.loading = document.getElementById('loading');
                this.videoInfo = document.getElementById('videoInfo');
                this.videoThumbnail = document.getElementById('videoThumbnail');
                this.videoTitle = document.getElementById('videoTitle');
                this.videoDuration = document.getElementById('videoDuration');
                this.videoAuthor = document.getElementById('videoAuthor');
                this.videoViews = document.getElementById('videoViews');
                this.qualityOptions = document.getElementById('qualityOptions');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.downloadText = document.getElementById('downloadText');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                this.backendStatus = document.getElementById('backendStatus');
                
                // Your Netlify backend URL
                this.apiBaseUrl = 'https://rmdownloader.netlify.app/.netlify/functions';
                
                this.selectedFormat = null;
                this.videoData = null;
                
                this.initEventListeners();
                this.testBackendConnection();
            }

            async testBackendConnection() {
                try {
                    this.backendStatus.textContent = 'Testing...';
                    this.backendStatus.style.color = '#ffc107';
                    
                    const testUrl = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
                    const response = await fetch(`${this.apiBaseUrl}/youtube-info?url=${encodeURIComponent(testUrl)}`);
                    
                    if (response.ok) {
                        this.backendStatus.textContent = '✅ Connected';
                        this.backendStatus.style.color = '#28a745';
                    } else {
                        const errorData = await response.json();
                        this.backendStatus.textContent = '❌ Error: ' + (errorData.error || response.statusText);
                        this.backendStatus.style.color = '#dc3545';
                    }
                } catch (error) {
                    this.backendStatus.textContent = '❌ Connection Failed';
                    this.backendStatus.style.color = '#dc3545';
                    console.error('Backend connection test failed:', error);
                }
            }

            initEventListeners() {
                this.fetchBtn.addEventListener('click', () => this.fetchVideoInfo());
                this.videoUrl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.fetchVideoInfo();
                    }
                });
                this.downloadBtn.addEventListener('click', () => this.downloadVideo());
                
                this.videoUrl.addEventListener('input', () => {
                    this.hideError();
                    this.hideSuccess();
                });
            }

            showError(message) {
                this.errorMessage.innerHTML = `<strong>Error:</strong> ${message}`;
                this.errorMessage.style.display = 'block';
                this.successMessage.style.display = 'none';
            }

            showSuccess(message) {
                this.successMessage.innerHTML = `<strong>Success:</strong> ${message}`;
                this.successMessage.style.display = 'block';
                this.errorMessage.style.display = 'none';
            }

            hideError() {
                this.errorMessage.style.display = 'none';
            }

            hideSuccess() {
                this.successMessage.style.display = 'none';
            }

            validateYouTubeUrl(url) {
                const regex = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                return regex.test(url);
            }

            async fetchVideoInfo() {
                const url = this.videoUrl.value.trim();
                
                if (!url) {
                    this.showError('Please enter a YouTube URL');
                    return;
                }

                if (!this.validateYouTubeUrl(url)) {
                    this.showError('Please enter a valid YouTube URL. Example: https://www.youtube.com/watch?v=VIDEO_ID');
                    return;
                }

                this.setLoading(true);
                this.videoInfo.style.display = 'none';
                this.hideError();
                this.hideSuccess();

                try {
                    const apiUrl = `${this.apiBaseUrl}/youtube-info?url=${encodeURIComponent(url)}`;
                    console.log('Fetching from:', apiUrl);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.videoData = data;
                    this.displayVideoInfo();
                    this.showSuccess('Video information fetched successfully!');

                } catch (error) {
                    console.error('Fetch error:', error);
                    this.showError('Failed to fetch video information: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }

            displayVideoInfo() {
                if (!this.videoData) return;

                // Set thumbnail
                this.videoThumbnail.src = this.videoData.thumbnail;
                this.videoThumbnail.onerror = () => {
                    this.videoThumbnail.src = 'https://via.placeholder.com/300x169?text=Thumbnail+Not+Available';
                };
                
                this.videoTitle.textContent = this.videoData.title;
                this.videoDuration.textContent = `Duration: ${this.videoData.duration}`;
                this.videoAuthor.textContent = `Channel: ${this.videoData.author}`;
                this.videoViews.textContent = '';

                this.qualityOptions.innerHTML = '';
                
                if (this.videoData.formats && this.videoData.formats.length > 0) {
                    this.videoData.formats.forEach((format) => {
                        const button = document.createElement('button');
                        button.className = 'quality-btn';
                        button.innerHTML = `
                            <span class="quality-label">${format.quality}</span>
                            <span class="quality-details">${format.format.toUpperCase()} • ${format.size}</span>
                        `;
                        button.addEventListener('click', () => this.selectFormat(format, button));
                        this.qualityOptions.appendChild(button);
                    });
                } else {
                    this.qualityOptions.innerHTML = '<p style="text-align: center; color: #666;">No formats available for this video.</p>';
                }

                this.videoInfo.style.display = 'block';
            }

            selectFormat(format, button) {
                document.querySelectorAll('.quality-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });

                button.classList.add('selected');
                this.selectedFormat = format;
                this.downloadBtn.style.display = 'block';
                this.downloadText.textContent = `Download ${format.quality} ${format.format.toUpperCase()} (${format.size})`;
            }

            async downloadVideo() {
                if (!this.selectedFormat || !this.videoData) {
                    this.showError('Please select a video quality first');
                    return;
                }

                try {
                    this.downloadBtn.disabled = true;
                    this.downloadText.textContent = 'Preparing download...';

                    const videoUrl = this.videoUrl.value.trim();
                    const apiUrl = `${this.apiBaseUrl}/youtube-download?url=${encodeURIComponent(videoUrl)}&itag=${this.selectedFormat.itag}`;
                    
                    console.log('Downloading from:', apiUrl);
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const downloadData = await response.json();
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = downloadData.downloadUrl;
                    const safeTitle = this.videoData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    link.download = `${safeTitle}.${this.selectedFormat.format}`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showSuccess(`Download started: ${this.videoData.title}`);

                } catch (error) {
                    this.showError('Download failed: ' + error.message);
                } finally {
                    this.downloadBtn.disabled = false;
                    this.downloadText.textContent = `Download ${this.selectedFormat.quality} ${this.selectedFormat.format.toUpperCase()}`;
                }
            }

            setLoading(loading) {
                this.fetchBtn.disabled = loading;
                this.fetchText.textContent = loading ? 'Fetching...' : 'Fetch Video';
                this.loading.style.display = loading ? 'block' : 'none';
            }
        }

        // Global function to test backend
        function testBackend() {
            const downloader = new YouTubeDownloader();
        }

        // Initialize the downloader when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new YouTubeDownloader();
        });
    </script>
</body>
</html>
